@{
    ViewBag.Title = "Цели";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/angular-datepicker.css" rel="stylesheet" type="text/css" />

<div class="page-header">
    <h1>Список задач</h1>
</div>
<div class="panel" ng-app="targetApp" ng-controller="targetController">
    <div class="form-inline">
        <div class="form-group">
            <div class="col-lg-7">
                <input class="form-control" ng-model="name" placeholder="Цель" />
            </div>
            <div class="col-lg-4">
                <datepicker date-format="dd-MM">
                    <input ng-model="date" type="text"/>
                </datepicker>
            </div>
            <div class="col-lg-1">
                <button class="btn btn-default" ng-click="addItem(name, date)">Добавить</button>
            </div>
        </div>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Цель</th>
                <th>Дата</th>
                <th>Сделано</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="item in list.items | orderBy:'date'" ng-style="item.isToday && {'background-color': 'yellow'}">
                <td>{{item.name}}</td>
                <td>{{item.date | date:'dd-MM'}}</td>
                <td><input type="checkbox" ng-model="item.done" ng-click="update(item)" ng-style="somestyle" /></td>
                <td><button class="btn btn-default" ng-click="delete(item)">Удалить</button></td>
            </tr>
        </tbody>
    </table>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.11/angular.min.js"></script>
<script src="~/Scripts/angular-datepicker.js"></script>
<script>
    var targetApp = angular.module("targetApp", ['720kb.datepicker']);

    targetApp.controller("targetController", function ($scope, $http) {

        $scope.somestyle = { background: 'yellow', color: 'red' };

        $http.get('GetData').success(function (data) {
            var model = {
                items: []
            };
            $scope.list = model;

            var today = new Date();
            $.each(data, function (i, item) {
                var date = item.date;
                item.date = new Date(parseInt(date.replace('/Date(', '')));
                item.isToday = (today.toDateString() === item.date.toDateString());
                $scope.list.items.push(item);
            });
        });

        $scope.addItem = function (text, date) {
            var dd = date.substring(0, 2);
            var mm = date.substring(3);
            var m = parseInt(mm) - 1;
            var d = new Date(2015, m, dd);
            var target = {
                id: null,
                name: text,
                date: d,
                done: false
            };
            $scope.list.items.push(target);
            $.ajax({
                url: '/target/add',
                type: 'POST',
                data: JSON.stringify(target),
                contentType: "application/json;charset=utf-8"
            });
        };

        $scope.delete = function (item) {
            var index = $scope.list.items.indexOf(item);
            $scope.list.items.splice(index, 1);
            $.ajax({
                url: '/target/delete',
                type: 'POST',
                data: JSON.stringify(item),
                contentType: "application/json;charset=utf-8"
            });
        };

        $scope.update = function (item) {
            $.ajax({
                url: '/target/update',
                type: 'POST',
                data: JSON.stringify(item),
                contentType: "application/json;charset=utf-8"
            });
        };

        $scope.getDayClass = function (date, mode) {
            if (mode === 'day') {
                var dayToCheck = new Date(date).setHours(0, 0, 0, 0);

                for (var i = 0; i < $scope.events.length; i++) {
                    var currentDay = new Date($scope.events[i].date).setHours(0, 0, 0, 0);

                    if (dayToCheck === currentDay) {
                        return $scope.events[i].status;
                    }
                }
            }

            return '';
        };
    });
</script>